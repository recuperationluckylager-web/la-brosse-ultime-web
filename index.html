<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Brosse Ultime ‚Äî Prototype</title>

  <!-- Polices + Tailwind (config minimal via CDN) -->
  <script>
    tailwind = { config: { theme: { extend: { fontFamily: { sans:['Inter','sans-serif'], title:['Bangers','cursive'] }, colors: { 'fjord-dark':'#1a202c','fjord-light':'#2d3748','beer-gold':'#f59e0b' } } } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{ --fjord-dark:#1a202c; --fjord-light:#2d3748; --beer-gold:#f59e0b;}
    html,body{height:100%;margin:0}
    body{background:var(--fjord-dark); color:#cbd5e0; font-family:'Inter',sans-serif; -webkit-font-smoothing:antialiased}
    .font-title{font-family:'Bangers',cursive; letter-spacing:1px}
    .game-page{display:none} .game-page.active{display:block}
    .btn{display:inline-block;padding:.5rem .9rem;border-radius:.45rem;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--beer-gold);color:#111}
    .btn-secondary{background:var(--fjord-light);color:#e2e8f0}
    .btn-choice{display:block;width:100%;text-align:left;background:var(--fjord-light);color:#e2e8f0;margin-bottom:.5rem;padding:.6rem;border-radius:.5rem;border:0}
    .map-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;aspect-ratio:1/1;max-width:520px;margin:auto;border:2px solid #4a5568;background:var(--fjord-light);padding:6px;transform-origin:center center}
    .map-cell{background:#4a5568;opacity:.6;display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#a0aec0;position:relative;min-height:28px;border-radius:6px}
    .map-cell.discovered{opacity:1;color:white}
    .map-cell.player-location::after{content:'YOU';position:absolute;font-size:.6rem;font-weight:700;color:var(--beer-gold);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:12px}
    .inventory-slot{background:var(--fjord-light);border:2px solid #4a5568;border-radius:10px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;position:relative}
    .item-qty{position:absolute;right:6px;bottom:6px;font-size:.75rem;color:#cbd5e0;font-weight:700}
    #modal{display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
    #modal .card{background:var(--fjord-light);padding:18px;border-radius:10px;max-width:640px;width:100%}
    /* Dice modal visuals */
    #dice-modal{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.62);align-items:center;justify-content:center}
    #dice-card{width:320px;max-width:90%;background:var(--fjord-light);padding:18px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:12px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    #dice-svg{transform-origin:center center;transition:transform .6s cubic-bezier(.2,.9,.2,1)}
    #dice-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:var(--beer-gold);text-shadow:0 4px 18px rgba(0,0,0,.6);opacity:0;transition:opacity .24s}
    #dice-confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:10001;display:none}
  </style>
</head>
<body class="h-full">

  <!-- GAME PAGE -->
  <div id="page-jeu" class="game-page active p-4 md:p-8 max-w-6xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <main class="lg:col-span-2 bg-[color:var(--fjord-light)] p-6 rounded-lg shadow-lg">
        <section class="scene">
          <h2 id="scene-titre" class="font-title text-3xl text-white mb-4">Chargement...</h2>
          <div class="scene-image-container w-full h-56 bg-gray-700 rounded-lg mb-4 overflow-hidden">
            <img id="scene-image" src="https://placehold.co/800x400/2d3748/4a5568?text=Chargement..." alt="Plan" class="w-full h-full object-cover">
          </div>
          <div id="scene-texte" class="text-lg text-gray-300 leading-relaxed mb-6">...</div>
          <div id="choices-container" class="border-t border-gray-600 pt-4" role="list"></div>
        </section>
      </main>

      <aside class="lg:col-span-1 space-y-6">
        <div class="stats bg-[color:var(--fjord-light)] p-6 rounded-lg shadow-lg">
          <h3 class="font-title text-2xl text-white mb-4 border-b border-gray-600 pb-2">Stats</h3>
          <ul class="space-y-2 text-lg">
            <li>Brosse : <span id="s-brosse" class="font-bold text-[color:var(--beer-gold)]">0</span></li>
            <li>Buzz : <span id="s-buzz" class="font-bold text-green-400">0</span></li>
            <li>Lucidit√© : <span id="s-lucidite" class="font-bold text-blue-400">0</span></li>
            <li>T√©nacit√© : <span id="s-tenacite" class="font-bold text-red-400">0</span></li>
            <li>Relation : <span id="s-relation" class="font-bold text-pink-400">0</span></li>
          </ul>
        </div>

        <div class="journal bg-[color:var(--fjord-light)] p-6 rounded-lg shadow-lg">
          <h3 class="font-title text-2xl text-white mb-4 border-b border-gray-600 pb-2">Journal</h3>
          <div id="log-box" class="h-56 overflow-y-auto bg-gray-800 p-3 rounded-md text-gray-400 text-sm space-y-2" role="log" aria-live="polite"></div>
        </div>

        <div class="space-y-2">
          <button id="open-inventory" class="btn btn-secondary w-full">üß∞ Inventaire</button>
          <button id="open-map" class="btn btn-secondary w-full">üó∫Ô∏è Carte</button>
          <button id="save-btn" class="btn btn-primary w-full">üíæ Sauvegarder</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- MAP PAGE -->
  <div id="page-carte" class="game-page p-4 md:p-8 max-w-5xl mx-auto">
    <header class="flex justify-between items-center mb-6">
      <h1 class="font-title text-3xl text-white">Carte du Fjord</h1>
      <div class="flex gap-2 items-center">
        <button id="map-zoom-in" class="btn btn-secondary">+</button>
        <button id="map-zoom-out" class="btn btn-secondary">-</button>
        <button id="map-back" class="btn btn-primary">Retour</button>
      </div>
    </header>
    <div class="md:col-span-2 bg-[color:var(--fjord-light)] p-6 rounded-lg shadow-lg">
      <div id="map-grid-container" class="map-grid"></div>
    </div>
    <aside class="mt-4">
      <h2 class="font-title text-2xl text-white mb-4">Zones D√©couvertes</h2>
      <ul id="zone-list-dynamic" class="space-y-2 text-gray-300"></ul>
    </aside>
  </div>

  <!-- GENERIC MODAL -->
  <div id="modal" aria-hidden="true">
    <div class="card">
      <h3 id="modal-title" class="font-title text-2xl text-white mb-3">...</h3>
      <div id="modal-body" class="text-gray-300 mb-4"></div>
      <div class="flex gap-3 justify-end">
        <button id="modal-close" class="btn btn-primary">Fermer</button>
      </div>
    </div>
  </div>

  <!-- DICE MODAL (VISUAL) + CANVAS -->
  <div id="dice-modal" aria-hidden="true">
    <div id="dice-card">
      <div id="dice-modal-title" class="font-title text-white">Lancer</div>
      <div id="dice-visual" style="width:120px;height:120px;position:relative">
        <svg id="dice-svg" viewBox="0 0 100 100" width="100%" height="100%">
          <rect x="5" y="5" width="90" height="90" rx="12" ry="12" fill="#0f1724" stroke="#94a3b8" stroke-width="2"></rect>
          <g id="dice-dots" transform="translate(0,0)"></g>
        </svg>
        <div id="dice-overlay"></div>
      </div>
      <div id="dice-modal-body" class="text-gray-300">R√©sultat: <span id="dice-count" class="font-bold">‚Ä¶</span></div>
      <div style="display:flex;gap:8px;width:100%;justify-content:center"><button id="dice-modal-ok" class="btn btn-primary">OK</button></div>
    </div>
    <canvas id="dice-confetti"></canvas>
  </div>

  <script>
    // ---------- Data (inlined) ----------
    const gameData = {
      items: {
        biere: { name:'Bi√®re Fjord Sombre', icon:'üç∫', usable:true, action:'boireBiere' },
        duct_tape: { name:'Tape Gris', icon:'ü©π', usable:false },
        chips: { name:'Chips BBQ', icon:'ü•®', usable:true, action:'mangerChips' }
      },
      map: {
        layout: [
          [0,0,1,1,0,0,0,0,0,0],
          [0,0,1,1,0,0,0,0,0,0],
          [0,0,0,2,0,0,0,0,0,0],
          [0,0,0,2,0,0,0,0,0,0],
          [0,0,0,2,2,2,3,3,0,0],
          [0,0,0,0,0,0,3,3,0,0],
          [0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0]
        ],
        zones: {
          1: { id:'chalet', name:'Chalet', color:'#6366f1' },
          2: { id:'sentier', name:'Sentier', color:'#84cc16' },
          3: { id:'quai', name:'Quai', color:'#06b6d4' }
        }
      },
      scenes: {
        start: {
          title:'Le R√©veil Brumeux',
          location:'Chalet du Fjord',
          image:'https://placehold.co/800x400/2d3748/4a5568?text=Vue+du+Chalet',
          text:"Tu te r√©veilles sur le divan-lit. √áa sent le feu de camp d'hier pis la bi√®re.",
          choices:[
            { text:"Ouvrir une bi√®re tablette.", target:'boire_biere_matin', action:'trouverBiere' },
            { text:"Prendre un caf√© instant.", target:'cafe_matin' },
            { text:"Rejoindre Valette sur le patio.", target:'patio_valette' }
          ]
        },
        boire_biere_matin: {
          title:'Le Poil de la B√™te',
          image:'https://placehold.co/800x400/d97706/4a5568?text=Bi√®re+matinale',
          text:"La premi√®re gorg√©e est difficile, mais le buzz revient tranquillement.",
          choices:[ { text:"Aller la rejoindre.", target:'patio_valette' }, { text:"Retour", target:'start' } ]
        },
        cafe_matin: {
          title:'Le Nescaf√©',
          image:'https://placehold.co/800x400/78350f/4a5568?text=Caf√©+douteux',
          text:"Le liquide brun te donne un peu de lucidit√©.",
          choices:[ { text:"Aller sur le patio.", target:'patio_valette' }, { text:"Retour", target:'start' } ]
        },
        patio_valette: {
          title:'Patio avec Vue',
          image:'https://placehold.co/800x400/5a6782/4a5568?text=Patio',
          text:"Valette te regarde en riant.",
          choices:[
            { text:"Faire un test de T√©nacit√© (D20 >= 10).", dice:{ faces:20, threshold:10, onSuccess:'vers_quai', onFailure:'panique_biere' } },
            { text:"Chercher dans le cabanon.", target:'idee_cabanon' }
          ]
        },
        idee_cabanon: {
          title:'Le Cabanon',
          image:'https://placehold.co/800x400/4a5568/a0aec0?text=Le+Cabanon',
          text:"Tu trouves un rouleau de TAPE GRIS presque neuf.",
          choices:[ { text:"Prendre le tape gris.", target:'patio_valette', action:'trouverTape' } ]
        },
        vers_quai: {
          title:'Le Sentier Bouetteux',
          location:'Sentier Bouetteux',
          image:'https://placehold.co/800x400/5f370e/a0aec0?text=Bouette',
          text:"Le sentier est bouetteux.",
          choices:[ { text:"Continuer prudemment.", target:'quai_pecheur' } ]
        },
        panique_biere: {
          title:'La Crise',
          image:'https://placehold.co/800x400/c53030/4a5568?text=Panique',
          text:"Panique, il faut trouver de la bi√®re.",
          choices:[ { text:"Retour", target:'patio_valette' } ]
        },
        quai_pecheur: {
          title:'Le Quai du P√™cheur',
          image:'https://placehold.co/800x400/06b6d4/4a5568?text=Quai',
          text:"Le vieux p√™cheur bricole son filet.",
          choices:[ { text:"Retour", target:'start' } ]
        }
      }
    };

    // ---------- App state ----------
    const app = {
      state: {
        currentScene: 'start',
        location: 'Chalet du Fjord',
        stats: { brosse:3, buzz:5, lucidite:15, tenacite:10, relation:2 },
        inventory: [ { id:'biere', qty:4 }, { id:'duct_tape', qty:1 }, { id:'chips', qty:2 } ],
        mapZones: ['chalet'],
        journal: ['La brosse commence...']
      },
      rng: () => Math.random(),
      setRNG(fn) { this.rng = typeof fn === 'function' ? fn : () => Math.random(); }
    };

    // ---------- addLog & modal helpers ----------
    function addLog(msg) {
      app.state.journal = app.state.journal || [];
      app.state.journal.push(msg);
      if (app.state.journal.length > 300) app.state.journal.shift();
      renderJournal();
    }

    function showModal(title, body) {
      const m = document.getElementById('modal');
      document.getElementById('modal-title').textContent = title;
      const mb = document.getElementById('modal-body');
      mb.textContent = typeof body === 'string' ? body : String(body);
      m.style.display = 'flex'; m.setAttribute('aria-hidden', 'false');
    }

    function hideModal() {
      const m = document.getElementById('modal');
      m.style.display = 'none'; m.setAttribute('aria-hidden', 'true');
    }

    // Ensure app.addLog exists for dice manager
    if (typeof app.addLog !== 'function') app.addLog = addLog;

    // ---------- Enhanced DiceManager ----------
    app.dice = {
      history: [],
      rng() { return (app.rng && typeof app.rng === 'function') ? app.rng() : Math.random(); },

      _playSound(success = true) {
        try {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          const ctx = new Ctx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = success ? 'sine' : 'triangle';
          o.frequency.value = success ? 880 : 220;
          g.gain.value = 0;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          g.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 0.01);
          g.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.22);
          o.stop(ctx.currentTime + 0.25);
        } catch (e) {}
      },

      _burstConfetti(x = window.innerWidth / 2, y = window.innerHeight / 2, count = 20) {
        try {
          const canvas = document.getElementById('dice-confetti');
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          canvas.width = innerWidth; canvas.height = innerHeight; canvas.style.display = 'block';
          const particles = [];
          for (let i = 0; i < count; i++) {
            particles.push({
              x, y,
              vx: (Math.random() - 0.5) * 8,
              vy: (Math.random() * -6) - 2,
              size: 6 + Math.random() * 8,
              color: ['#f59e0b','#06b6d4','#84cc16','#f97316','#ef4444'][Math.floor(Math.random() * 5)],
              life: 50 + Math.floor(Math.random() * 40)
            });
          }
          let t = 0;
          const anim = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let p of particles) {
              p.vy += 0.25; p.x += p.vx; p.y += p.vy; p.life--;
              ctx.fillStyle = p.color;
              ctx.fillRect(p.x, p.y, p.size, p.size * 0.6);
            }
            t++;
            for (let i = particles.length - 1; i >= 0; i--) if (particles[i].life <= 0) particles.splice(i, 1);
            if (particles.length > 0 && t < 400) requestAnimationFrame(anim); else { ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display = 'none'; }
          };
          anim();
        } catch (e) {}
      },

      _drawDots(n) {
        const dots = document.getElementById('dice-dots');
        if (!dots) return;
        while (dots.firstChild) dots.removeChild(dots.firstChild);
        const mk = (cx, cy) => {
          const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          c.setAttribute('cx', String(cx)); c.setAttribute('cy', String(cy)); c.setAttribute('r', '4.5');
          c.setAttribute('fill', '#f8fafc');
          dots.appendChild(c);
        };
        const coords = {
          1: [[50,50]],
          2: [[30,30],[70,70]],
          3: [[30,30],[50,50],[70,70]],
          4: [[30,30],[30,70],[70,30],[70,70]],
          5: [[30,30],[30,70],[70,30],[70,70],[50,50]],
          6: [[30,22],[30,50],[30,78],[70,22],[70,50],[70,78]]
        };
        if (n >= 1 && n <= 6) coords[n].forEach(c => mk(c[0], c[1])); else {
          const t = document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x','50'); t.setAttribute('y','58'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','36'); t.setAttribute('fill','#f8fafc'); t.setAttribute('font-weight','700');
          t.textContent = String(n);
          dots.appendChild(t);
        }
      },

      roll({ faces = 20, mod = 0, threshold = null, animate = true } = {}) {
        const self = this;
        return new Promise((resolve) => {
          const raw = Math.floor(self.rng() * faces) + 1;
          const total = raw + (Number(mod) || 0);
          const ok = threshold === null ? null : (total >= threshold);
          const result = { roll: raw, faces, mod, total, ok, ts: Date.now() };
          self.history.push(result); if (self.history.length > 300) self.history.shift();

          if (typeof app.addLog === 'function') {
            if (ok === null) app.addLog(`Lancer D${faces} => ${total}`);
            else app.addLog(`Test D${faces} (${threshold}) => ${total} (${ok ? 'OK' : 'KO'})`);
          }

          try {
            const modal = document.getElementById('dice-modal');
            const svg = document.getElementById('dice-svg');
            const overlay = document.getElementById('dice-overlay');
            const countEl = document.getElementById('dice-count');
            const titleEl = document.getElementById('dice-modal-title');

            if (!modal || !svg || !countEl) { resolve(result); return; }

            titleEl.textContent = `Lancer D${faces}`;
            overlay.style.opacity = '0';
            countEl.textContent = '‚Ä¶';
            const isD6 = faces === 6;
            const steps = Math.min(12, Math.max(6, Math.floor(faces / 2)));
            let step = 0;

            const frame = () => {
              step++;
              const interm = Math.floor(self.rng() * Math.min(6, faces)) + 1;
              if (isD6) self._drawDots(interm);
              else {
                const dots = document.getElementById('dice-dots');
                while (dots.firstChild) dots.removeChild(dots.firstChild);
                const t = document.createElementNS('http://www.w3.org/2000/svg','text');
                t.setAttribute('x','50'); t.setAttribute('y','58'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','28'); t.setAttribute('fill','#f8fafc');
                t.textContent = String(interm);
                dots.appendChild(t);
              }
              if (step < steps) setTimeout(frame, 40 + Math.random()*30);
              else {
                if (isD6 && raw <= 6) self._drawDots(raw);
                else {
                  const dots = document.getElementById('dice-dots');
                  while (dots.firstChild) dots.removeChild(dots.firstChild);
                  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
                  t.setAttribute('x','50'); t.setAttribute('y','58'); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','36'); t.setAttribute('fill','#f8fafc'); t.setAttribute('font-weight','700');
                  t.textContent = String(total);
                  dots.appendChild(t);
                }
                svg.style.transform = 'rotate(0deg) scale(1)';
                overlay.textContent = total;
                overlay.style.opacity = '1';
                countEl.textContent = String(total) + (ok === null ? '' : (ok ? ' ‚úì' : ' ‚úï'));
                if (ok === true) { self._burstConfetti(window.innerWidth/2, window.innerHeight/2); self._playSound(true); }
                else if (ok === false) { self._playSound(false); }
              }
            };

            modal.style.display = 'flex';
            svg.style.transform = 'rotate(720deg) scale(.96)';
            setTimeout(() => frame(), 80);
          } catch (e) {
            console.error('dice UI error', e);
          }

          setTimeout(() => resolve(result), 180);
        });
      }
    };

    // ---------- Actions & Conditions ----------
    const actions = {
      boireBiere() {
        app.state.stats.brosse = (app.state.stats.brosse || 0) + 1;
        app.state.stats.buzz = (app.state.stats.buzz || 0) + 2;
        app.state.stats.lucidite = (app.state.stats.lucidite || 0) - 1;
        addLog('Tu cales une bi√®re. Le buzz monte.');
      },
      mangerChips() {
        app.state.stats.lucidite = (app.state.stats.lucidite || 0) + 1;
        addLog('Tu manges des chips.');
      },
      trouverBiere() {
        addLog('Tu trouves une bi√®re !');
        const b = (app.state.inventory || []).find(i => i.id === 'biere');
        if (b) b.qty += 1; else (app.state.inventory = app.state.inventory || []).push({ id:'biere', qty: 1 });
      },
      trouverTape() {
        addLog('Tu trouves du TAPE GRIS !');
        const t = (app.state.inventory || []).find(i => i.id === 'duct_tape');
        if (t) t.qty += 1; else (app.state.inventory = app.state.inventory || []).push({ id:'duct_tape', qty: 1 });
      },
      decouvrirSentier() {
        app.state.mapZones = app.state.mapZones || [];
        if (!app.state.mapZones.includes('sentier')) app.state.mapZones.push('sentier');
        addLog('Tu as d√©couvert le Sentier Bouetteux.');
      }
    };

    const conditions = {
      aBiere() { const b = (app.state.inventory || []).find(i => i.id === 'biere'); return !!(b && b.qty > 0); },
      aTape() { const t = (app.state.inventory || []).find(i => i.id === 'duct_tape'); return !!(t && t.qty > 0); },
      luciditeBasse() { return (app.state.stats?.lucidite || 0) < 10; },
      luciditeHaute() { return (app.state.stats?.lucidite || 0) >= 10; }
    };

    // ---------- Rendering ----------
    function renderHUD() {
      const s = app.state.stats || {};
      document.getElementById('s-brosse').textContent = s.brosse ?? 0;
      document.getElementById('s-buzz').textContent = s.buzz ?? 0;
      document.getElementById('s-lucidite').textContent = s.lucidite ?? 0;
      document.getElementById('s-tenacite').textContent = s.tenacite ?? 0;
      document.getElementById('s-relation').textContent = s.relation ?? 0;
    }

    function renderJournal() {
      const box = document.getElementById('log-box'); box.innerHTML = '';
      (app.state.journal || []).forEach(entry => {
        const p = document.createElement('div'); p.textContent = `‚Ä¢ ${entry}`; p.style.lineHeight = '1.35'; box.appendChild(p);
      });
      box.scrollTop = box.scrollHeight;
    }

    function renderScene(sceneId) {
      if (!sceneId) sceneId = 'start';
      const scene = gameData.scenes[sceneId];
      if (!scene) { console.error('Sc√®ne inconnue', sceneId); addLog(`Erreur: Sc√®ne ${sceneId} introuvable.`); return; }
      app.state.currentScene = sceneId;
      if (scene.location) app.state.location = scene.location;
      document.getElementById('scene-titre').textContent = scene.title || '';
      document.getElementById('scene-texte').innerHTML = scene.text || '';
      document.getElementById('scene-image').src = scene.image || '';
      const container = document.getElementById('choices-container'); container.innerHTML = '';
      (scene.choices || []).forEach(choice => {
        if (choice.condition && conditions[choice.condition] && !conditions[choice.condition]()) return;
        const btn = document.createElement('button'); btn.className = 'btn-choice'; btn.textContent = choice.text;
        if (choice.action) btn.dataset.action = choice.action;
        if (choice.target) btn.dataset.target = choice.target;
        if (choice.dice) {
          btn.dataset.dice = 'true';
          btn.dataset.faces = choice.dice.faces;
          if (choice.dice.mod) btn.dataset.mod = choice.dice.mod;
          if (choice.dice.threshold) btn.dataset.threshold = choice.dice.threshold;
          if (choice.dice.onSuccess) btn.dataset.onSuccess = choice.dice.onSuccess;
          if (choice.dice.onFailure) btn.dataset.onFailure = choice.dice.onFailure;
        }
        container.appendChild(btn);
      });
      renderHUD();
      saveGame(true);
    }

    function renderInventoryModal() {
      const inv = (app.state.inventory || []).map(i => {
        const meta = gameData.items[i.id] || {}; return `${meta.icon || ''} ${meta.name || i.id} x${i.qty}`;
      }).join('\n') || 'Vide';
      showModal('Inventaire', inv);
    }

    function renderMap() {
      const grid = document.getElementById('map-grid-container');
      const zoneList = document.getElementById('zone-list-dynamic');
      if (!grid || !zoneList) return;
      grid.innerHTML = ''; zoneList.innerHTML = '';
      const mapData = gameData.map || {}; const layout = mapData.layout || []; const zones = mapData.zones || {};
      const playerMapId = (app.state.location || '').includes('Sentier') ? 'sentier' : ((app.state.location || '').includes('Quai') ? 'quai' : 'chalet');
      layout.forEach((row,y) => { row.forEach((cellId,x) => {
        const cell = document.createElement('div'); cell.className = 'map-cell';
        if (cellId && zones[cellId]) {
          const z = zones[cellId];
          if ((app.state.mapZones || []).includes(z.id)) { cell.classList.add('discovered'); cell.textContent = z.name; if (z.color) cell.style.backgroundColor = z.color; }
          if (z.id === playerMapId) cell.classList.add('player-location');
          cell.title = z.name;
        }
        grid.appendChild(cell);
      }); });
      (app.state.mapZones || []).forEach(zoneId => {
        const zone = Object.values(zones).find(z => z.id === zoneId);
        if (!zone) return;
        const li = document.createElement('li'); li.innerHTML = `<span class="inline-block w-3 h-3 rounded-full mr-2" style="background:${zone.color}"></span>${zone.name}`;
        zoneList.appendChild(li);
      });
    }

    // ---------- Persistence ----------
    function saveGame(silent = true) {
      try { localStorage.setItem('brosseUltimeSave', JSON.stringify(app.state)); if (!silent) showModal('Sauvegarde', 'Partie sauvegard√©e.'); } catch (e) { console.error('Sauvegarde √©chou√©e', e); if (!silent) showModal('Erreur', 'Impossible de sauvegarder.'); }
    }

    function loadGame() {
      try {
        const s = localStorage.getItem('brosseUltimeSave');
        if (s) { const parsed = JSON.parse(s); if (parsed && typeof parsed === 'object') app.state = parsed; addLog('Partie charg√©e depuis le navigateur.'); }
      } catch (e) { console.error('Chargement √©chou√©', e); }
    }

    // ---------- Event handling ----------
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-choice');
      if (btn) {
        btn.disabled = true; setTimeout(() => btn.disabled = false, 350);
        const action = btn.dataset.action; const target = btn.dataset.target;
        if (action && typeof actions[action] === 'function') {
          try { actions[action](); } catch (err) { console.error('Action error', err); addLog('Erreur action'); }
        }
        if (btn.dataset.dice === 'true') {
          const faces = Number(btn.dataset.faces || 20);
          const mod = Number(btn.dataset.mod || 0);
          const threshold = btn.dataset.threshold ? Number(btn.dataset.threshold) : null;
          const onSuccess = btn.dataset.onSuccess; const onFailure = btn.dataset.onFailure;
          app.dice.roll({ faces, mod, threshold, animate: true }).then(res => {
            if (res.ok === true && onSuccess) renderScene(onSuccess);
            else if (res.ok === false && onFailure) renderScene(onFailure);
            else if (target) renderScene(target);
            saveGame(true);
          });
          return;
        }
        if (target) renderScene(target);
        saveGame(true);
        return;
      }

      if (e.target.id === 'open-inventory') renderInventoryModal();
      if (e.target.id === 'open-map') { document.getElementById('page-jeu').classList.remove('active'); document.getElementById('page-carte').classList.add('active'); renderMap(); }
      if (e.target.id === 'map-back') { document.getElementById('page-carte').classList.remove('active'); document.getElementById('page-jeu').classList.add('active'); }
      if (e.target.id === 'save-btn') { saveGame(false); showModal('Sauvegarde', 'Partie sauvegard√©e.'); }
      if (e.target.id === 'modal-close') hideModal();
      if (e.target.id === 'dice-modal-ok') { document.getElementById('dice-modal').style.display = 'none'; }
      if (e.target.id === 'map-zoom-in') { const mg = document.getElementById('map-grid-container'); mg.dataset.scale = Math.min(2, Number(mg.dataset.scale || 1) + 0.12); mg.style.transform = `scale(${mg.dataset.scale})`; }
      if (e.target.id === 'map-zoom-out') { const mg = document.getElementById('map-grid-container'); mg.dataset.scale = Math.max(0.5, Number(mg.dataset.scale || 1) - 0.12); mg.style.transform = `scale(${mg.dataset.scale})`; }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'm') { document.getElementById('page-jeu').classList.remove('active'); document.getElementById('page-carte').classList.add('active'); renderMap(); }
      if (e.key === 'i') renderInventoryModal();
    });

    // Attach modal close listeners after DOM loaded
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('modal-close').addEventListener('click', hideModal);
      document.getElementById('dice-modal-ok').addEventListener('click', () => { document.getElementById('dice-modal').style.display = 'none'; });
      // Load saved game then render starting scene
      loadGame();
      if (!app.state.currentScene) app.state.currentScene = 'start';
      renderScene(app.state.currentScene);
      renderHUD();
      renderJournal();
    });

    // expose for debugging
    window.app = app;
    window.gameData = gameData;
  </script>
</body>
</html>